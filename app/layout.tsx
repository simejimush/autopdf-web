import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { createSupabaseServerClient } from "@/lib/supabase/server";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const supabase = await createSupabaseServerClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  let isGoogleConnected = false;
  let hasActiveRule = false;

  if (user) {
    // Googleæ¥ç¶šåˆ¤å®š
    const { data: gc } = await supabase
      .from("google_connections")
      .select("id")
      .eq("user_id", user.id)
      .maybeSingle();

    isGoogleConnected = !!gc;

    // ğŸ”´ ã“ã“ã‹ã‚‰è¿½åŠ 
    // ç›´è¿‘ã‚¨ãƒ©ãƒ¼å–å¾—
    let lastErrorRun: {
      rule_id: string | null;
      finished_at: string | null;
      message: string | null;
    } | null = null;

    const { data: myRules } = await supabase
      .from("rules")
      .select("id")
      .eq("user_id", user.id);

    const ruleIds = (myRules ?? []).map((x) => x.id);

    if (ruleIds.length > 0) {
      const { data: errRun } = await supabase
        .from("runs")
        .select("rule_id, finished_at, message")
        .in("rule_id", ruleIds)
        .eq("status", "error")
        .order("finished_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      lastErrorRun = errRun ?? null;
    }

    // æœ‰åŠ¹ãƒ«ãƒ¼ãƒ«åˆ¤å®šï¼ˆã¾ãš is_active ã‚’æ¡ç”¨ï¼‰
    const { data: rules } = await supabase
      .from("rules")
      .select("id")
      .eq("user_id", user.id)
      .eq("is_active", true)
      .limit(1);

    hasActiveRule = !!rules && rules.length > 0;
  }

  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {user && !isGoogleConnected && (
          <div className="ap-banner">
            <span className="ap-banner__text">
              Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæœªæ¥ç¶šã§ã™ã€‚è‡ªå‹•å®Ÿè¡Œã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯æ¥ç¶šãŒå¿…è¦ã§ã™ã€‚
            </span>

            <a href="/api/google/connect" className="ap-banner__action">
              <button className="ap-banner__btn">Googleã«æ¥ç¶š</button>
            </a>
          </div>
        )}
        {user && isGoogleConnected && !hasActiveRule && (
          <div className="ap-banner ap-banner--info">
            <span className="ap-banner__text">
              æœ‰åŠ¹ãªãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            </span>

            <a href="/rules/new" className="ap-banner__action">
              <button className="ap-banner__btn ap-banner__btn--info">
                ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆ
              </button>
            </a>
          </div>
        )}
        {user && isGoogleConnected && lastErrorRun && (
          <div className="ap-banner ap-banner--danger">
            <span className="ap-banner__text">
              ç›´è¿‘ã®å®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </span>

            <a
              href={
                lastErrorRun.rule_id
                  ? `/rules/${lastErrorRun.rule_id}`
                  : "/rules"
              }
              className="ap-banner__action"
            >
              <button className="ap-banner__btn ap-banner__btn--danger">
                ç¢ºèªã™ã‚‹
              </button>
            </a>
          </div>
        )}

        {children}
        <style>{`
  .ap-banner{
  background:#FEF3C7;
  border-bottom:1px solid #F59E0B;
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  font-size:14px;
  color:#1F2937; /* â† è¿½åŠ ã—ã¦ã‚‚OK */
}
  .ap-banner__text{
  line-height:1.4;
  color:#1F2937; /* â† è¿½åŠ ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰ */
  font-weight:500;
}
  .ap-banner__action{
    flex:0 0 auto;
  }
  .ap-banner__btn{
    background:#4F46E5;
    color:#fff;
    padding:8px 14px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:600;
    white-space:nowrap;
  }
    .ap-banner--info{
  background:#E0F2FE;
  border-bottom:1px solid #38BDF8;
}
.ap-banner__btn--info{
  background:#2563EB;
}
  .ap-banner--danger{
  background:#FEE2E2;
  border-bottom:1px solid #FCA5A5;
}
.ap-banner__btn--danger{
  background:#DC2626;
}

  /* âœ… ã‚¹ãƒãƒ›ã ã‘ï¼šãƒ†ã‚­ã‚¹ãƒˆã®ä¸‹ã«ãƒœã‚¿ãƒ³ã€ãƒœã‚¿ãƒ³ã¯å³å¯„ã›ï¼ˆ3æšç›®ã®é…ç½®ï¼‰ */
  @media (max-width: 640px){
    .ap-banner{
      flex-direction:column;
      align-items:stretch;
    }
    .ap-banner__action{
      display:flex;
      justify-content:flex-end;
    }
  }
`}</style>
      </body>
    </html>
  );
}
